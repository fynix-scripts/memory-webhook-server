<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="utf-8" />
<title>Callback</title>
</head>
<body>
<p>Logger ind...</p>

<script>
const DISCORD_CLIENT_ID = '1403793707085594705'
const DISCORD_CLIENT_SECRET = 'CXZLaFb8Lw-uwV4x0LPDj3DiWmRbQywS'  // Erstat med din client secret
const REDIRECT_URI = 'https://pghosting.dk//callback.html'

async function fetchAccessToken(code) {
  const params = new URLSearchParams()
  params.append('client_id', DISCORD_CLIENT_ID)
  params.append('client_secret', DISCORD_CLIENT_SECRET)
  params.append('grant_type', 'authorization_code')
  params.append('code', code)
  params.append('redirect_uri', REDIRECT_URI)
  params.append('scope', 'identify email')

  const response = await fetch('https://discord.com/api/oauth2/token', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded'
    },
    body: params.toString()
  })

  if (!response.ok) throw new Error('Token fetch failed')
  return await response.json()
}

async function fetchUserData(token) {
  const response = await fetch('https://discord.com/api/users/@me', {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  if (!response.ok) throw new Error('User fetch failed')
  return await response.json()
}

async function main() {
  const params = new URLSearchParams(window.location.search)
  const code = params.get('code')
  if (!code) {
    alert('Ingen kode fundet i URL')
    return
  }

  try {
    const tokenData = await fetchAccessToken(code)
    const userData = await fetchUserData(tokenData.access_token)

    const avatarUrl = userData.avatar
      ? `https://cdn.discordapp.com/avatars/${userData.id}/${userData.avatar}.png?size=128`
      : 'https://cdn.discordapp.com/embed/avatars/0.png'

    const user = {
      id: userData.id,
      username: userData.username,
      avatarUrl
    }
    localStorage.setItem('discordUser', JSON.stringify(user))

    window.location.href = 'index.html'
  } catch (e) {
    alert('Noget gik galt: ' + e.message)
  }
}

main()
</script>
</body>
</html>